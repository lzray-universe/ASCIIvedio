name: build-asciiplay-linux

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (FFmpeg dev + toolchain)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config patchelf \
            libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libswresample-dev

      # 如需强制 C++17，解开下两行（否则按项目默认）
      # - name: Configure (CMake Release, C++17)
      #   working-directory: ./asciiplay
      #   run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_EXTENSIONS=OFF

      - name: Configure (CMake Release)
        working-directory: ./asciiplay
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: ./asciiplay
        run: cmake --build build -j

      - name: Bundle runtime libs (portable)
        working-directory: ./asciiplay
        env:
          ARTIFACT: ${{ github.workspace }}/asciiplay-linux-x86_64.tar.gz
        run: |
          set -euo pipefail
          mkdir -p dist/bin dist/lib
          cp build/asciiplay dist/bin/

          # 1) 先带上核心 FFmpeg 动态库
          for n in libavcodec libavformat libavutil libswscale libswresample; do
            find /usr/lib/x86_64-linux-gnu -maxdepth 1 -name "${n}.so*" -exec cp -v {} dist/lib/ \; || true
          done

          # 2) 用 ldd 扫描依赖，排除 glibc 基础件
          EXCL='(linux-vdso|ld-linux|/lib/x86_64-linux-gnu/libc\.so|/lib/x86_64-linux-gnu/libm\.so|/lib/x86_64-linux-gnu/libdl\.so|/lib/x86_64-linux-gnu/libpthread\.so|/lib/x86_64-linux-gnu/librt\.so|/lib/x86_64-linux-gnu/libgcc_s\.so)'
          scan_copy() {
            local f="$1"
            ldd "$f" | awk '/=>/ {print $3} /^\/.*/ {print $1}' | \
              grep -E '^/' | grep -Ev "$EXCL" | sort -u | \
              xargs -r -I{} cp -vn {} dist/lib/ || true
          }
          # 3) 递归几轮拿到传递依赖
          for i in 1 2 3; do
            scan_copy dist/bin/asciiplay
            for so in dist/lib/*.so*; do [ -f "$so" ] && scan_copy "$so"; done
          done

          # 4) 带上 libstdc++（不同机器版本易不一致）
          cp -vn /usr/lib/x86_64-linux-gnu/libstdc++.so.* dist/lib/ || true

          # 5) 设 RPATH：../lib
          patchelf --set-rpath '$ORIGIN/../lib' dist/bin/asciiplay || true


          # 7) 打包到仓库根（绝对路径），并校验存在
          tar -C dist -czf "$ARTIFACT" .
          test -s "$ARTIFACT"
          sha256sum "$ARTIFACT"
          echo "Packed -> $ARTIFACT"

      - name: List files (debug)
        run: |
          pwd
          ls -lah
          find . -maxdepth 2 -type f -name "*.tar.gz" -ls

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asciiplay-linux-x86_64
          path: ${{ github.workspace }}/asciiplay-linux-x86_64.tar.gz
          if-no-files-found: error

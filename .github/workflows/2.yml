name: build-asciiplay-windows-portable

on:
  push:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 安装 vcpkg 并构建 FFmpeg (x64)
      - name: Setup vcpkg
        run: |
          $env:VCPKG_ROOT = "$env:USERPROFILE\vcpkg"
          if (-not (Test-Path $env:VCPKG_ROOT)) {
            git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
            & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"
          }
          # 安装 FFmpeg 动态库（带 x264；可按需增减特性）
          & "$env:VCPKG_ROOT\vcpkg.exe" install ffmpeg[x264]:x64-windows
          echo "VCPKG_ROOT=$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

      # 如需热修 FindFFmpeg.cmake（把 av${lc} 改为 ${lc}），取消下面注释
      # - name: Hotfix FindFFmpeg.cmake (fix library names)
      #   run: |
      #     $ff = Join-Path $PWD "asciiplay\cmake\FindFFmpeg.cmake"
      #     if (Test-Path $ff) {
      #       (Get-Content $ff) -replace 'NAMES av\$\{lc\}', 'NAMES ${lc}' | Set-Content $ff -Encoding UTF8
      #     }

      # 配置（按需强制 C++17：加 -DCMAKE_CXX_STANDARD=17）
      - name: Configure (CMake Release, MSVC + vcpkg)
        working-directory: ./asciiplay
        run: >
          cmake -S . -B build
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          -DCMAKE_BUILD_TYPE=Release
          # -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_EXTENSIONS=OFF

      - name: Build (Release)
        working-directory: ./asciiplay
        run: cmake --build build --config Release -j

      - name: Bundle portable (exe + all needed DLLs)
        working-directory: ./asciiplay
        run: |
          $ErrorActionPreference = "Stop"
          $dist = Join-Path $PWD "dist"
          $bin  = Join-Path $dist "bin"
          New-Item -Force -ItemType Directory -Path $bin | Out-Null

          # 1) 复制可执行文件
          $exe = Join-Path $PWD "build\Release\asciiplay.exe"
          if (-not (Test-Path $exe)) { throw "asciiplay.exe not found at $exe" }
          Copy-Item $exe $bin

          # 2) 复制 vcpkg 安装的 FFmpeg 及所有依赖 DLL
          $vbin = Join-Path $env:VCPKG_ROOT "installed\x64-windows\bin"
          if (-not (Test-Path $vbin)) { throw "vcpkg bin not found: $vbin" }
          Copy-Item "$vbin\*.dll" $bin -Force

          # 3) 自检（允许非零退出，不作为失败）
          Push-Location $dist
          try {
            Write-Host "=== smoke test: run asciiplay without input (expect an error message but loader works) ==="
            & ".\bin\asciiplay.exe" "--help" ; $LASTEXITCODE = 0
            & ".\bin\asciiplay.exe" ; $LASTEXITCODE = 0
          } catch {
            Write-Warning "asciiplay run produced non-zero exit; this is acceptable for no-input. Loader OK."
          } finally {
            Pop-Location
          }

          # 4) 打包到仓库根目录
          $zip = Join-Path $env:GITHUB_WORKSPACE "asciiplay-windows-x64.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$dist\*" -DestinationPath $zip
          Write-Host "Packed -> $zip"
          Get-ChildItem $zip | Format-List

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asciiplay-windows-x64
          path: ${{ github.workspace }}/asciiplay-windows-x64.zip
          if-no-files-found: error

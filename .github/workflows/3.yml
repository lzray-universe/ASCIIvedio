name: build-asciiplay-windows-portable-fast

on:
  push:
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch FFmpeg 4.4.x (use your BtbN link; fallback to gyan)
        run: |
          $ErrorActionPreference = "Stop"
          $FFROOT = "C:\ffmpeg"
          New-Item -Force -ItemType Directory -Path $FFROOT | Out-Null

          # === 1) 你的 BtbN 固定链接（shared） + 推断 dev 包名 ===
          $tag    = "autobuild-2023-12-31-12-55"
          $base   = "https://github.com/BtbN/FFmpeg-Builds/releases/download/$tag"
          $shared = "ffmpeg-n4.4.4-89-g25841e4f90-win64-gpl-shared-4.4.zip"
          $dev    = "ffmpeg-n4.4.4-89-g25841e4f90-win64-gpl-dev-4.4.zip"  # 同批次 dev

          $sharedUrl = "$base/$shared"
          $devUrl    = "$base/$dev"

          $SevenZip = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $SevenZip)) {
            choco install -y 7zip
            $SevenZip = "C:\Program Files\7-Zip\7z.exe"
          }

          $sharedZip = Join-Path $FFROOT "ffmpeg-shared.zip"
          $devZip    = Join-Path $FFROOT "ffmpeg-dev.zip"

          $haveShared = $false
          $haveDev    = $false

          try {
            Write-Host "Downloading SHARED: $sharedUrl"
            Invoke-WebRequest $sharedUrl -OutFile $sharedZip -Headers @{ "User-Agent"="actions" } -UseBasicParsing -TimeoutSec 300
            $haveShared = Test-Path $sharedZip
          } catch { Write-Warning "Shared download failed: $($_.Exception.Message)" }

          try {
            Write-Host "Downloading DEV: $devUrl"
            Invoke-WebRequest $devUrl -OutFile $devZip -Headers @{ "User-Agent"="actions" } -UseBasicParsing -TimeoutSec 300
            $haveDev = Test-Path $devZip
          } catch { Write-Warning "Dev download failed: $($_.Exception.Message)" }

          if ($haveShared -and $haveDev) {
            & "$SevenZip" x $sharedZip -o"$FFROOT" -y
            & "$SevenZip" x $devZip    -o"$FFROOT" -y

            $devDir = Get-ChildItem -Directory $FFROOT | Where-Object {
              $_.Name -match 'win64' -and $_.Name -match 'dev' -and
              (Test-Path "$($_.FullName)\include") -and (Test-Path "$($_.FullName)\lib")
            } | Select-Object -First 1

            $sharedDir = Get-ChildItem -Directory $FFROOT | Where-Object {
              $_.Name -match 'win64' -and $_.Name -match 'shared' -and
              (Test-Path "$($_.FullName)\bin")
            } | Select-Object -First 1

            if (-not $devDir -or -not $sharedDir) {
              Write-Warning "Extracted but folder shape unexpected, will fallback to gyan."
            } else {
              $env:FFMPEG_DEV    = $devDir.FullName
              $env:FFMPEG_SHARED = $sharedDir.FullName
            }
          }

          # === 2) Fallback：gyan.dev 4.4.1 full_build-shared（带 include/lib/bin）===
          if (-not $env:FFMPEG_DEV -or -not $env:FFMPEG_SHARED) {
            Write-Host "FALLBACK to gyan.dev 4.4.1 full_build-shared"
            $Url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-4.4.1-full_build-shared.7z"
            $Dst = Join-Path $FFROOT "ffmpeg-gyan.7z"
            Invoke-WebRequest $Url -OutFile $Dst -UseBasicParsing -TimeoutSec 300
            & "$SevenZip" x $Dst -o"$FFROOT" -y

            $full = Get-ChildItem -Directory $FFROOT | Where-Object {
              $_.Name -like 'ffmpeg-4.4.1-full_build-shared*'
            } | Select-Object -First 1

            if (-not $full) { throw "Fallback failed: gyan.dev 4.4.1 not found after extract." }

            # gyan 的 full_build-shared 同时有 include/lib/bin
            $env:FFMPEG_DEV    = $full.FullName
            $env:FFMPEG_SHARED = $full.FullName
          }

          Add-Content -Path $env:GITHUB_ENV -Value ("FFMPEG_DEV="    + $env:FFMPEG_DEV)
          Add-Content -Path $env:GITHUB_ENV -Value ("FFMPEG_SHARED=" + $env:FFMPEG_SHARED)
          Write-Host "FFMPEG_DEV    = $env:FFMPEG_DEV"
          Write-Host "FFMPEG_SHARED = $env:FFMPEG_SHARED"

      - name: Configure (VS2022 x64, Release; link old FFmpeg)
        working-directory: ./asciiplay
        run: |
          # 强制 MSVC，避免误选 MinGW
          Remove-Item Env:CC  -ErrorAction SilentlyContinue
          Remove-Item Env:CXX -ErrorAction SilentlyContinue

          cmake -S . -B build `
            -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_EXTENSIONS=OFF `
            -DFFMPEG_INCLUDE_DIR="$env:FFMPEG_DEV\include" `
            -DFFMPEG_AVFORMAT_LIBRARY="$env:FFMPEG_DEV\lib\avformat.lib" `
            -DFFMPEG_AVCODEC_LIBRARY="$env:FFMPEG_DEV\lib\avcodec.lib" `
            -DFFMPEG_AVUTIL_LIBRARY="$env:FFMPEG_DEV\lib\avutil.lib" `
            -DFFMPEG_SWSCALE_LIBRARY="$env:FFMPEG_DEV\lib\swscale.lib" `
            -DFFMPEG_SWRESAMPLE_LIBRARY="$env:FFMPEG_DEV\lib\swresample.lib" `
            -DCMAKE_EXE_LINKER_FLAGS="/link ws2_32.lib bcrypt.lib" `
            -DCMAKE_COMPILE_WARNING_AS_ERROR=OFF `
            -DCMAKE_CXX_FLAGS="/WX- /wd4244 /wd4100 /external:W0 /external:anglebrackets"

      - name: Build (Release, MSVC)
        working-directory: ./asciiplay
        run: cmake --build build --config Release -- /m

      - name: Bundle portable zip (exe + FFmpeg DLLs)
        working-directory: ./asciiplay
        run: |
          $ErrorActionPreference = "Stop"
          $dist = Join-Path $PWD "dist"
          $bin  = Join-Path $dist "bin"
          New-Item -Force -ItemType Directory -Path $bin | Out-Null

          $exe = Join-Path $PWD "build\Release\asciiplay.exe"
          if (-not (Test-Path $exe)) { throw "asciiplay.exe not found at $exe" }
          Copy-Item $exe $bin

          # DLLs：优先用 shared 包（若 fallback，shared=dev=同一目录也没问题）
          Copy-Item "$env:FFMPEG_SHARED\bin\*.dll" $bin -Force

          # 自检（无输入允许非零）
          Push-Location $dist
          try {
            & ".\bin\asciiplay.exe" "--help" ; $LASTEXITCODE = 0
            & ".\bin\asciiplay.exe" ; $LASTEXITCODE = 0
          } catch {
            Write-Warning "Run produced non-zero exit (no input). Loader OK."
          } finally {
            Pop-Location
          }

          $zip = Join-Path $env:GITHUB_WORKSPACE "asciiplay-windows-x64-ffmpeg4x.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$dist\*" -DestinationPath $zip
          Write-Host "Packed -> $zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asciiplay-windows-x64-ffmpeg4x
          path: ${{ github.workspace }}/asciiplay-windows-x64-ffmpeg4x.zip
          if-no-files-found: error

name: build-asciiplay-windows-gcc-portable

on:
  push:
  workflow_dispatch:

jobs:
  build-win-gcc:
    runs-on: windows-2022
    defaults:
      run:
        shell: msys2 {0}   # 关键：让后续步骤在 MSYS2/MINGW64 下跑

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up MSYS2 (MINGW64) with GCC, CMake, Ninja, FFmpeg, ntldd, zip
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-ffmpeg
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-ntldd
            zip

      - name: Print toolchain versions
        run: |
          g++ --version
          cmake --version
          ninja --version
          pkg-config --modversion libavformat libavcodec libavutil libswscale libswresample || true

      - name: Configure (GCC + Ninja; use MSYS2 FFmpeg)
        working-directory: ./asciiplay
        run: |
          set -euxo pipefail
          cmake -S . -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_STANDARD=17 \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_EXTENSIONS=OFF \
            -DFFMPEG_INCLUDE_DIR=/mingw64/include \
            -DFFMPEG_AVFORMAT_LIBRARY=/mingw64/lib/libavformat.dll.a \
            -DFFMPEG_AVCODEC_LIBRARY=/mingw64/lib/libavcodec.dll.a \
            -DFFMPEG_AVUTIL_LIBRARY=/mingw64/lib/libavutil.dll.a \
            -DFFMPEG_SWSCALE_LIBRARY=/mingw64/lib/libswscale.dll.a \
            -DFFMPEG_SWRESAMPLE_LIBRARY=/mingw64/lib/libswresample.dll.a

      - name: Build (Release, GCC)
        working-directory: ./asciiplay
        run: cmake --build build --config Release -- -v

      - name: Bundle portable zip (exe + all dependent DLLs)
        working-directory: ./asciiplay
        run: |
          set -euxo pipefail
          dist="$PWD/dist"
          bin="$dist/bin"
          mkdir -p "$bin"

          exe="$PWD/build/asciiplay.exe"
          test -f "$exe"
          cp "$exe" "$bin/"

          # 递归解析并拷贝 exe 依赖（含 FFmpeg 与 GCC 运行时）
          /mingw64/bin/ntldd -R "$bin/asciiplay.exe" \
            | awk '{for(i=1;i<=NF;i++) if ($i ~ /mingw64\/bin\/.*\.dll$/) print $i}' \
            | sort -u \
            | xargs -I{} cp -u "{}" "$bin/"

          # 可选：再对 bin/*.dll 递归一遍，保险
          for f in "$bin"/*.dll; do
            /mingw64/bin/ntldd -R "$f" \
              | awk '{for(i=1;i<=NF;i++) if ($i ~ /mingw64\/bin\/.*\.dll$/) print $i}' \
              | sort -u \
              | xargs -I{} cp -u "{}" "$bin/" || true
          done

          # 简单自检
          ( "$bin/asciiplay.exe" --help || true )

          # 打包
          pushd "$dist"
          zip -9r "$GITHUB_WORKSPACE/asciiplay-windows-gcc-x64.zip" *
          popd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asciiplay-windows-gcc-x64
          path: ${{ github.workspace }}/asciiplay-windows-gcc-x64.zip
          if-no-files-found: error
          # 正确写入后续 step 可见的环境变量
          $env:FFSUB = $Sub.FullName
          Add-Content -Path $env:GITHUB_ENV -Value ("FFSUB=" + $env:FFSUB)
          Write-Host "FFSUB = $env:FFSUB"

      # 如需修正 FindFFmpeg.cmake（把 av${lc} 改为 ${lc}），取消下面注释
      # - name: Hotfix FindFFmpeg.cmake (fix library names)
      #   run: (Get-Content .\asciiplay\cmake\FindFFmpeg.cmake) -replace 'NAMES av\$\{lc\}','NAMES ${lc}' | Set-Content .\asciiplay\cmake\FindFFmpeg.cmake -Encoding UTF8

      - name: Configure (Visual Studio 2022 x64, Release; use prebuilt FFmpeg)
        working-directory: ./asciiplay
        run: |
          # 防止 Ninja/MinGW 被选中
          Remove-Item Env:CC -ErrorAction SilentlyContinue
          Remove-Item Env:CXX -ErrorAction SilentlyContinue

          cmake -S . -B build `
            -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_EXTENSIONS=OFF `
            -DFFMPEG_INCLUDE_DIR="$env:FFSUB\include" `
            -DFFMPEG_AVFORMAT_LIBRARY="$env:FFSUB\lib\avformat.lib" `
            -DFFMPEG_AVCODEC_LIBRARY="$env:FFSUB\lib\avcodec.lib" `
            -DFFMPEG_AVUTIL_LIBRARY="$env:FFSUB\lib\avutil.lib" `
            -DFFMPEG_SWSCALE_LIBRARY="$env:FFSUB\lib\swscale.lib" `
            -DFFMPEG_SWRESAMPLE_LIBRARY="$env:FFSUB\lib\swresample.lib" `
            -DCMAKE_EXE_LINKER_FLAGS="/link ws2_32.lib bcrypt.lib" `
            -DCMAKE_COMPILE_WARNING_AS_ERROR=OFF `
            -DCMAKE_CXX_FLAGS="/WX- /wd4244 /wd4100 /external:W0 /external:anglebrackets"
      - name: Build (Release, MSVC)
        working-directory: ./asciiplay
        run: cmake --build build --config Release -- /m

      - name: Bundle portable zip (exe + FFmpeg DLLs)
        working-directory: ./asciiplay
        run: |
          $ErrorActionPreference = "Stop"
          $dist = Join-Path $PWD "dist"
          $bin  = Join-Path $dist "bin"
          New-Item -Force -ItemType Directory -Path $bin | Out-Null

          $exe = Join-Path $PWD "build\Release\asciiplay.exe"
          if (-not (Test-Path $exe)) { throw "asciiplay.exe not found at $exe" }
          Copy-Item $exe $bin

          # 带上 FFmpeg 运行时 dll（来自预编译包）
          Copy-Item "$env:FFSUB\bin\*.dll" $bin -Force

          # 简单自检（无输入允许非零）
          Push-Location $dist
          try {
            & ".\bin\asciiplay.exe" "--help" ; $LASTEXITCODE = 0
            & ".\bin\asciiplay.exe" ; $LASTEXITCODE = 0
          } catch {
            Write-Warning "Run produced non-zero exit (no input). Loader OK."
          } finally {
            Pop-Location
          }

          $zip = Join-Path $env:GITHUB_WORKSPACE "asciiplay-windows-x64.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$dist\*" -DestinationPath $zip
          Write-Host "Packed -> $zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asciiplay-windows-x64
          path: ${{ github.workspace }}/asciiplay-windows-x64.zip
          if-no-files-found: error

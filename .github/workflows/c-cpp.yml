name: build-asciiplay-linux

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (FFmpeg dev + toolchain)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config patchelf \
            libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libswresample-dev

      - name: Configure (CMake Release)
        working-directory: ./asciiplay
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: ./asciiplay
        run: cmake --build build -j

      - name: Bundle runtime libs
        working-directory: ./asciiplay
        run: |
          set -e
          mkdir -p dist/bin dist/lib
          cp build/asciiplay dist/bin/

          # 仅拷贝 FFmpeg 相关 .so，避免包过大
          for n in libavcodec libavformat libavutil libswscale libswresample; do
            find /usr/lib/x86_64-linux-gnu -maxdepth 1 -name "${n}*.so*" -exec cp -v {} dist/lib/ \;
          done

          # 让可执行在 dist/bin 下能直接找到 ../lib
          patchelf --set-rpath '$ORIGIN/../lib' dist/bin/asciiplay || true

          tar -C dist -czf ../asciiplay-linux-x86_64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asciiplay-linux-x86_64
          path: asciiplay-linux-x86_64.tar.gz
          if-no-files-found: error
